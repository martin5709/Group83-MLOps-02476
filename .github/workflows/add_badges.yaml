name: Add Badges to Repo

on:
  push:
    branches:
      - main

jobs:
  add_coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: setup.py

      - name: Install dependencies
        run: |
          python -m pip install -U pip setuptools wheel
          pip install -r requirements.txt
          pip install -r requirements_dev.txt
          pip install -e .
          pip list

      - name: Setup temp folder
        run: |
          cd CNNDetection
          mkdir tmp
          cd ..
      
      - name: Run and save coverage
        run: |
          OUTPUT=$(pytest --cov=group83_mlops tests/ | grep "TOTAL" | awk '{print $4}')
          COLOUR="crimson"
          if [ "$OUTPUT" -gt 94 ]; then
            COLOUR="lime"
          elif [ "$OUTPUT" -gt 89 ]; then
            COLOUR="green"
          elif [ "$OUTPUT" -gt 79 ]; then
            COLOUR="yellow"
          elif [ "$OUTPUT" -gt 69 ]; then
            COLOUR="orange"
          elif [ "$OUTPUT" -gt 49 ]; then
            COLOUR="red"
          else
            COLOUR="crimson"
          fi
          echo "{\"label\":\"coverage\",\"color\":\"$COLOUR\",\"message\":\"$OUTPUT\"}" > coveragebadge.json